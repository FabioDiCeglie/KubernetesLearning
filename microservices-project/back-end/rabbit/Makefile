.PHONY: run stop logs build clean test help

# Default target
run:
	@echo "ğŸš€ Starting RabbitMQ Service..."
	@echo "ğŸ° RabbitMQ uses the official Docker image"
	@echo "ğŸ’¡ Use 'make k8s-deploy' to deploy to Kubernetes"
	@echo "ğŸ’¡ Or run RabbitMQ locally with: docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management"

# Show help
help:
	@echo "Available targets:"
	@echo "  run      - Show how to start RabbitMQ locally"
	@echo "  k8s-deploy - Deploy to Kubernetes"
	@echo "  k8s-status - Check Kubernetes deployment status"
	@echo "  k8s-logs   - Show Kubernetes pod logs"
	@echo "  k8s-restart - Restart Kubernetes deployment"
	@echo "  k8s-test   - Test RabbitMQ in Kubernetes"
	@echo "  k8s-clean  - Remove from Kubernetes"
	@echo "  help     - Show this help"

# Kubernetes deployment targets
k8s-deploy:
	@echo "ğŸš€ Deploying to Kubernetes..."
	@cd manifests && chmod +x deploy.sh && ./deploy.sh

k8s-status:
	@echo "ğŸ“Š Kubernetes deployment status:"
	@echo "Pods:"
	@kubectl get pods -l app=rabbitmq
	@echo ""
	@echo "Services:"
	@kubectl get svc rabbitmq
	@echo ""
	@echo "PVC:"
	@kubectl get pvc rabbitmq-pvc
	@echo ""
	@echo "ConfigMaps:"
	@kubectl get configmap rabbitmq-configmap
	@echo ""
	@echo "Secrets:"
	@kubectl get secret rabbitmq-secret

k8s-logs:
	@echo "ğŸ“‹ Showing Kubernetes pod logs..."
	@kubectl logs -l app=rabbitmq --tail=50 -f

k8s-restart:
	@echo "ğŸ”„ Restarting RabbitMQ deployment..."
	@kubectl rollout restart deployment/rabbitmq
	@echo "â³ Waiting for rollout to complete..."
	@kubectl rollout status deployment/rabbitmq
	@echo "âœ… RabbitMQ deployment restarted successfully"

# Test RabbitMQ in Kubernetes
k8s-test:
	@echo "ğŸ§ª Testing RabbitMQ in Kubernetes with ClusterIP service..."
	@echo "ğŸ“Š Pod status:"; \
	kubectl get pods -l app=rabbitmq; \
	echo ""; \
	echo "ğŸŒ Service info:"; \
	kubectl get svc rabbitmq; \
	echo ""; \
	echo "ğŸ”Œ Since service type is ClusterIP, using port-forwarding for access..."; \
	echo "âœ… RabbitMQ is accessible via port-forwarding:"; \
	echo "  ğŸŒ Management UI: http://localhost:15672 (guest/guest)"; \
	echo "  ğŸ”Œ AMQP Port: localhost:5672"; \
	echo ""; \
	echo "ğŸ’¡ To access RabbitMQ, run in another terminal:"; \
	echo "  kubectl port-forward svc/rabbitmq 15672:15672 5672:5672"; \
	echo ""; \
	echo "ğŸ’¡ Test connection with:"; \
	echo "  curl -u guest:guest http://localhost:15672/api/overview"; \
	echo ""; \

k8s-clean:
	@echo "ğŸ§¹ Cleaning up Kubernetes resources..."
	@cd manifests && kubectl delete -f ./ || true
	@echo "âœ… Kubernetes cleanup complete"

k8s-context:
	@echo "ğŸ” Current Kubernetes context:"
	@kubectl config current-context
	@echo ""
	@echo "Cluster info:"
	@kubectl cluster-info 